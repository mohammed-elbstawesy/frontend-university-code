<app-navbar></app-navbar>

<section class="w-full max-w-7xl mx-auto animate-fade-in pb-24 px-4 md:px-6 pt-8">
    
    <!-- البطاقات الأربعة (بنفس التصميم المطلوب) -->
    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4 mb-12">
        <!-- Total Issues -->
        <div class="bg-[#1c1c2e] rounded-xl p-5 flex flex-col justify-center h-[100px] relative overflow-hidden border border-slate-800/50 shadow-lg">
            <div class="pl-1">
                <span class="text-sm text-slate-400 font-medium block mb-1 opacity-80">Total Issues</span>
                <span class="text-3xl font-bold text-white tracking-tight">{{ numberOfvuln }}</span>
            </div>
        </div>
        <!-- Critical -->
        <div class="bg-[#1c1c2e] rounded-xl p-5 flex flex-col justify-center h-[100px] relative overflow-hidden border border-slate-800/50 shadow-lg">
            <div class="absolute left-0 top-4 bottom-4 w-1.5 rounded-r-full bg-[#ff003c]"></div>
            <div class="pl-3">
                <span class="text-sm text-slate-400 font-medium block mb-1 opacity-80">Critical</span>
                <span class="text-3xl font-bold text-[#ff003c] tracking-tight">{{ numberOfCritical }}</span>
            </div>
        </div>
        <!-- High Severity -->
        <div class="bg-[#1c1c2e] rounded-xl p-5 flex flex-col justify-center h-[100px] relative overflow-hidden border border-slate-800/50 shadow-lg">
            <div class="absolute left-0 top-4 bottom-4 w-1.5 rounded-r-full bg-orange-500"></div>
            <div class="pl-3">
                <span class="text-sm text-slate-400 font-medium block mb-1 opacity-80">High Severity</span>
                <span class="text-3xl font-bold text-orange-500 tracking-tight">{{ numberOfHigh }}</span>
            </div>
        </div>
        <!-- Status -->
        <div class="bg-[#1c1c2e] rounded-xl p-5 flex flex-col justify-center h-[100px] relative overflow-hidden border border-slate-800/50 shadow-lg">
            <div class="pl-1">
                <span class="text-sm text-slate-400 font-medium block mb-1 opacity-80">Status</span>
                <span class="text-xl font-bold text-[#00ff9d] flex items-center gap-2 tracking-wide">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                    Finished
                </span>
            </div>
        </div>
    </div>

    <!-- عنوان النتائج وشريط البحث -->
    <div class="flex flex-col md:flex-row justify-between items-end gap-4 mb-8">
        <div>
            <h2 class="text-3xl font-bold text-white mb-2">Scan Results</h2>
            <p class="text-slate-400 text-sm">Target: <span class="text-[#00f0ff] font-mono">{{ urlName }}</span></p>
        </div>
        
        <div class="relative w-full md:w-auto flex items-center gap-3">
            
            <div class="relative flex-1">
                <input [(ngModel)]="searchTerm" type="text" placeholder="Search vulnerabilities..." class="w-full md:w-64 bg-[#13131f] border border-slate-700 rounded-lg py-2 px-4 pl-10 text-sm text-slate-300 focus:outline-none focus:border-[#00f0ff] transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="absolute left-3 top-2.5 text-slate-500"><circle cx="11" cy="11" r="8"></circle><line x1="21" x2="16.65" y1="21" y2="16.65"></line></svg>
            </div>

            <div class="relative">
                <button title="filter" (click)="toggleFilter()" 
                        [class]="'h-[42px] px-3 border rounded-lg flex items-center justify-center transition-all ' + (selectedSeverity !== 'All' ? 'bg-[#00f0ff]/10 border-[#00f0ff] text-[#00f0ff]' : 'bg-[#13131f] border-slate-700 text-slate-400 hover:border-slate-500 hover:text-white')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="4" x2="20" y1="21" y2="21"></line>
                        <line x1="4" x2="20" y1="3" y2="3"></line>
                        <line x1="4" x2="20" y1="9" y2="9"></line>
                        <line x1="4" x2="20" y1="15" y2="15"></line>
                        <circle cx="8" cy="9" r="2" fill="currentColor" fill-opacity="0.2"></circle>
                        <circle cx="16" cy="15" r="2" fill="currentColor" fill-opacity="0.2"></circle>
                    </svg>
                </button>

                @if (isFilterOpen) {
                    <div (click)="isFilterOpen = false" class="fixed inset-0 z-40"></div>

                    <div class="absolute right-0 top-full mt-2 w-40 bg-[#1a2236] border border-slate-700 rounded-xl shadow-xl z-50 overflow-hidden animate-fade-in">
                        <div class="py-1">
                            <button (click)="selectSeverity('All')" class="w-full text-left px-4 py-2 text-sm text-slate-300 hover:bg-white/5 hover:text-white transition-colors flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-slate-500"></span> All
                            </button>
                            <button (click)="selectSeverity('Critical')" class="w-full text-left px-4 py-2 text-sm text-slate-300 hover:bg-white/5 hover:text-[#ff003c] transition-colors flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-[#ff003c]"></span> Critical
                            </button>
                            <button (click)="selectSeverity('High')" class="w-full text-left px-4 py-2 text-sm text-slate-300 hover:bg-white/5 hover:text-orange-500 transition-colors flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-orange-500"></span> High
                            </button>
                            <button (click)="selectSeverity('Medium')" class="w-full text-left px-4 py-2 text-sm text-slate-300 hover:bg-white/5 hover:text-yellow-400 transition-colors flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-yellow-400"></span> Medium
                            </button>
                            <button (click)="selectSeverity('Low')" class="w-full text-left px-4 py-2 text-sm text-slate-300 hover:bg-white/5 hover:text-blue-400 transition-colors flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-blue-400"></span> Low
                            </button>
                        </div>
                    </div>
                }
            </div>

        </div>
    </div>

    <!-- شبكة البطاقات (تستخدم الآن filteredVulnerabilities) -->
    
     <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-24">
    @for (vuln of filteredVulns; track vuln._id) {
        <div class="group relative bg-[#1c1c2e] border border-slate-800 rounded-2xl p-6 transition-all duration-300 hover:border-slate-600 hover:bg-[#13131f] hover:-translate-y-2 shadow-xl shadow-black/40 overflow-hidden">
            <div class="absolute -inset-px bg-gradient-to-b from-slate-700/20 to-transparent opacity-0 group-hover:opacity-100 rounded-2xl pointer-events-none transition-opacity duration-500"></div>
            
            <div class="flex justify-between items-start mb-5 relative z-10">
             <div [className]="'px-3 py-1.5 rounded-3xl text-[11px] font-mono font-bold border flex items-center gap-2 tracking-wide ' + getSeverityClass(vuln.severity)">
    
    @if(vuln.severity === 'Critical') {
        <span class="relative flex items-center justify-center">
            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-current opacity-75"></span>
            <svg class="relative w-3.5 h-3.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path>
                <line x1="12" x2="12" y1="9" y2="13"></line>
                <line x1="12" x2="12.01" y1="17" y2="17"></line>
            </svg>
        </span>
    } 
    @else if (vuln.severity === 'High' || vuln.severity === 'Medium') {
        <svg class="w-3.5 h-3.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" x2="12" y1="8" y2="12"></line>
            <line x1="12" x2="12.01" y1="16" y2="16"></line>
        </svg>
    } 
    @else {
        <svg class="w-3.5 h-3.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" x2="12" y1="16" y2="12"></line>
            <line x1="12" x2="12.01" y1="8" y2="8"></line>
        </svg>
    }

    {{ vuln.severity | uppercase }}
</div>
                <span class="text-[10px] text-slate-500 font-mono bg-black/30 px-2 py-1 rounded border border-slate-800">{{ vuln._id }}</span>
            </div>

            <h3 class="text-lg font-bold text-slate-100 mb-3 group-hover:text-[#00f0ff] transition-colors line-clamp-1 relative z-10" [title]="vuln.name">
                {{ vuln.name }}
            </h3>
            
            <p class="text-slate-400 text-sm mb-6 line-clamp-3 leading-relaxed h-[60px] relative z-10">
                {{ vuln.smallDescription }}
            </p>

            <div class="flex justify-between items-center mt-auto pt-4 border-t border-slate-800/50 relative z-10">
                <span class="text-xs text-slate-600 flex items-center gap-1">
                   <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"></rect><line x1="16" x2="16" y1="2" y2="6"></line><line x1="8" x2="8" y1="2" y2="6"></line><line x1="3" x2="21" y1="10" y2="10"></line></svg>
                   Discovered: {{ vuln.date | date:'yyyy/MM/dd' }}
                </span>
                <button (click)="openModal(vuln)" class="flex items-center text-sm font-medium text-[#00f0ff] opacity-80 group-hover:opacity-100 transition-all hover:gap-2 cursor-pointer">
                    View Details 
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"></path></svg>
                </button>
            </div>
        </div>
    } @empty {
        <div class="col-span-full text-center py-10 text-slate-500">
            <p>No vulnerabilities found matching "{{ searchTerm }}"</p>
        </div>
    }
</div>
    

    <div class="fixed bottom-8 right-8 md:static md:mt-16 md:flex md:justify-center z-50">
        <button #btnRef (click)="downloadReport(btnRef)" class="bg-[#7000ff] hover:bg-purple-600 text-white px-8 py-4 rounded-xl font-semibold tracking-wide transition-all duration-300 flex items-center justify-center gap-3 shadow-[0_0_25px_rgba(112,0,255,0.3)] hover:shadow-[0_0_35px_rgba(112,0,255,0.5)] hover:-translate-y-1 cursor-pointer group">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="transition-transform group-hover:scale-110"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><path d="M12 18v-6"></path><path d="m9 15 3 3 3-3"></path></svg>
            <span>Download Full PDF Report</span>
        </button>
    </div>
@if (selectedVuln) {
    <div class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/80 animate-fade-in" (click)="closeModal()">

        <div class="relative w-full max-w-2xl">

            <!-- Card Container -->
<div class="bg-[#1c1c2e] border border-slate-700 rounded-2xl shadow-2xl overflow-hidden transform transition-all scale-100 min-h-[60vh]" (click)="$event.stopPropagation()">
                
                <!-- Header -->
                <div class="p-3 border-b border-slate-700/50 flex justify-between items-start">

                    <!-- LEFT SIDE -->
                    <!-- LEFT SIDE -->
<div class="flex items-center gap-3">

    <!-- Name -->
   

    <!-- Severity -->
    <span 
        [className]="'px-3 py-1 rounded-full text-xs font-mono font-bold border ' + getSeverityClass(selectedVuln.severity)">
        {{ selectedVuln.severity | uppercase }}
    </span>

     <h3 class="text-2xl font-bold text-white leading-tight">
        {{ selectedVuln.name }}
    </h3>

</div>


                    <!-- RIGHT SIDE (Date + Close) -->
                    <div class="flex items-start gap-3">

                        <!-- Date -->
                        <span class="text-xs text-slate-500 font-mono mt-1">
                            {{ selectedVuln.date | date:'mediumDate' }}
                        </span>

                        <!-- Close Button -->
                        <button title="close" (click)="closeModal()" 
                            class="text-slate-400 hover:text-white hover:bg-white/10 p-2 rounded-lg transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" 
                                 viewBox="0 0 24 24" fill="none" stroke="currentColor" 
                                 stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>

                    </div>

                </div>

                <!-- Content -->
                <div class="p-6 max-h-[60vh] overflow-y-auto custom-scrollbar">
                    <div>
                        <h4 class="text-sm font-semibold text-slate-400 mb-2 uppercase tracking-wider">Description</h4>
                        <p class="text-slate-200 leading-7 whitespace-pre-wrap">{{ selectedVuln.description }}</p>
                    </div>
                </div>

            </div>

            <!-- Transparent Footer (Glassy, no blur) -->
            <div class="absolute bottom-0 left-0 right-0 p-2 bg-[#13131f] border-t border-slate-700/50 flex justify-end rounded-b-2xl">
                <button (click)="closeModal()" class="px-6 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-medium transition-colors">
                    Close
                </button>
            </div>

        </div>

    </div>
}

</section>
